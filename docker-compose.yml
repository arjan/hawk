redis:
  image: redis
  expose:
    - "6379"
  volumes:
    - data/redis:/data
  command: redis-server --appendonly yes

nginx:
  image: klokantech/nginx
  ports:
    - "80:80"
  links:
    - embed
  volumes:
    - nginx/:/etc/nginx/conf.d/
    - .htpasswd:/etc/nginx/.htpasswd

embed:
  build: ./embed
  command: /usr/local/bin/supervisord -c /etc/supervisord/supervisord.conf
  expose:
    - "5000"
  links:
    - redis
  volumes:
    - ./embed:/usr/local/src/hawk/
  environment:
    - SERVER_NAME=media.embedr.eu
    - IIIF_SERVER=iiif.embedr.eu
    - REDIS_SERVER=redis
    - REDIS_PORT_NUMBER=6379

ingest:
  build: ./ingest
  links:
    - redis
  volumes:
    - ./embed:/usr/local/src/hawk/
    - data/tmp:/tmp
  environment:
    - C_FORCE_ROOT=true
    - REDIS_SERVER=redis
    - REDIS_PORT_NUMBER=6379
    - AWS_ACCESS_KEY_ID=
    - AWS_SECRET_ACCESS_KEY=
    - S3_CHUNK_SIZE=52428800
    - S3_HOST=s3.eu-central-1.amazonaws.com
    - S3_DEFAULT_BUCKET=storage.hawk.bucket
    - MAX_TASK_REPEAT=5
    - URL_OPEN_TIMEOUT=30
    - CLOUDSEARCH_REGION=eu-central-1
    - CLOUDSEARCH_ITEM_DOMAIN=hawk
    - CLOUDSEARCH_BATCH_DOMAIN=hawk-batch
  command: bash -c "celery --app=app.task_queue.task_queue worker --workdir=/usr/local/src/hawk/ --autoscale=10,3 --hostname worker1.%h && celery --app=app.task_queue.task_queue worker --workdir=/usr/local/src/hawk/ --autoscale=10,3 --hostname worker2.%h && celery --app=app.task_queue.task_queue worker --workdir=/usr/local/src/hawk/ --autoscale=10,3 --hostname worker3.%h"
